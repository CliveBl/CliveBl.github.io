<!DOCTYPE html>
<!-- Set language to Hebrew -->
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×”×¢×œ××ª ×§×‘×¦×™× ××™× ×˜×¨××§×˜×™×‘×™×ª</title>
  <!-- CSS Styles -->
  <style>
    /* Add these color variables at the top of the style section */
    :root {
      --bg-color: #ffffff;
      --text-color: #000000;
      --border-color: #ccc;
      --item-bg: #f8f9fa;
      --warning-bg: #fef9e7;
      --error-bg: #fde9e7;
      --default-border: #95a5a6;
      --warning-border: #f1c40f;
      --error-border: #e74c3c;
      --warning-text: #b7950b;
      --error-text: #c0392b;
      --button-text: white;
      --message-text: #666;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #1a1a1a;
        --text-color: #ffffff;
        --border-color: #404040;
        --item-bg: #2d2d2d;
        --warning-bg: #3d3415;
        --error-bg: #3d1f1d;
        --default-border: #606060;
        --warning-border: #b7950b;
        --error-border: #c0392b;
        --warning-text: #f1c40f;
        --error-text: #e74c3c;
        --button-text: #ffffff;
        --message-text: #b0b0b0;
      }
    }

    /* Update existing styles to use variables */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 600px;
      direction: rtl;
      text-align: right;
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    /* Remove default list styling */
    .file-list {
      list-style: none;
      padding: 0;
    }
    /* Style for each file item container */
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 6px 8px;
      margin-bottom: 6px;
      border-left: none;  /* Remove default left border */
      border-right: 4px solid var(--default-border);  /* Default gray border */
      background-color: var(--item-bg);
    }
    /* File name styling */
    .file-item span {
      flex-grow: 1;
      margin-left: 0;
      margin-right: 10px;
    }
    /* Delete button styling */
    .delete-button {
      background-color: #e74c3c;
      color: var(--button-text);
      border: none;
      padding: 4px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }
    /* Delete button hover effect */
    .delete-button:hover {
      background-color: #c0392b;
    }
    /* Add these new styles */
    .button-container {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .process-button {
      background-color: #2ecc71;
      color: var(--button-text);
      border: none;
      padding: 5px 15px;
      border-radius: 3px;
      cursor: pointer;
    }

    .process-button:hover {
      background-color: #27ae60;
    }

    /* Style for custom file input */
    .custom-file-input {
      display: flex;
      gap: 10px;
    }

    .custom-file-input input[type="file"] {
      display: none;
    }

    .custom-file-input label {
      background-color: #3498db;
      color: var(--button-text);
      padding: 5px 15px;
      border-radius: 3px;
      cursor: pointer;
      display: inline-block;
      transition: background-color 0.2s;
    }

    .custom-file-input label:hover {
      background-color: #2980b9;
    }

    /* Style for the second button */
    .custom-file-input label:nth-of-type(2) {
      background-color: #2ecc71;
    }

    .custom-file-input label:nth-of-type(2):hover {
      background-color: #27ae60;
    }

    /* Add these new styles */
    .message-container {
      margin-top: 20px;
    }

    .message-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      margin-bottom: 10px;
      background-color: var(--item-bg);
      border-right: 4px solid var(--default-border);
      border-radius: 3px;
    }

    .message-text {
      flex-grow: 1;
      margin-right: 0;
      margin-left: 10px;
    }

    .dismiss-button {
      background-color: #95a5a6;
      color: var(--button-text);
      border: none;
      padding: 3px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.8em;
    }

    .dismiss-button:hover {
      background-color: #7f8c8d;
    }

    /* Add these new styles */
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .login-button {
      background-color: #3498db;
      color: var(--button-text);
      border: none;
      padding: 8px 16px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
    }

    .login-button:hover {
      background-color: #2980b9;
    }

    /* Add these new styles for file status */
    .file-item.warning {
      border-right-color: var(--warning-border);
      background-color: var(--warning-bg);
    }

    .file-item.error {
      border-right-color: var(--error-border);
      background-color: var(--error-bg);
    }

    .status-icon {
      margin-left: 6px;
      font-size: 14px;
    }

    .status-message {
      font-size: 0.8em;
      color: var(--message-text);
      margin-right: 20px;
      display: block;
      margin-top: 2px;
      width: 100%;
    }

    .warning .status-message {
      color: var(--warning-text);
    }

    .error .status-message {
      color: var(--error-text);
    }

    /* Add icon and message container */
    .file-info {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .file-header {
      display: flex;
      align-items: center;
      font-size: 0.9em;
    }

    /* Add these new styles */
    .login-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .login-overlay.active {
      display: flex;
    }

    .login-modal {
      background-color: var(--bg-color);
      border-radius: 8px;
      padding: 20px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .login-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .login-header h2 {
      margin: 0;
    }

    .close-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-color);
      padding: 5px;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .login-form input {
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--item-bg);
      color: var(--text-color);
    }

    .login-submit {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    .login-submit:hover {
      background-color: #2980b9;
    }

    .login-divider {
      text-align: center;
      margin: 20px 0;
      position: relative;
    }

    .login-divider::before,
    .login-divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 45%;
      height: 1px;
      background-color: var(--border-color);
    }

    .login-divider::before {
      right: 0;
    }

    .login-divider::after {
      left: 0;
    }

    .login-divider span {
      background-color: var(--bg-color);
      padding: 0 10px;
      color: var(--text-color);
    }

    .social-login {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .social-login button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--item-bg);
      color: var(--text-color);
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .social-login button:hover {
      background-color: var(--border-color);
    }

    .social-login img {
      width: 20px;
      height: 20px;
    }

    /* Add these new styles */
    .mode-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }

    .toggle-button {
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      background: none;
      color: var(--text-color);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .toggle-button.active {
      background-color: #3498db;
      color: white;
      border-color: #3498db;
    }

    .signup-field {
      transition: all 0.3s ease;
    }

    .message-item.error {
      background-color: var(--error-bg);
      border-right: 4px solid var(--error-border);
    }

    .message-item.error .message-text {
      color: var(--error-text);
    }

    .message-item.warning {
      background-color: var(--warning-bg);
      border-right: 4px solid var(--warning-border);
    }

    .message-item.warning .message-text {
      color: var(--warning-text);
    }

    .message-item.info {
      background-color: var(--item-bg);
      border-right: 4px solid var(--default-border);
    }

    /* Add these styles to your existing CSS */
    .results-container {
      display: none;
      margin-top: 20px;
      border-top: 1px solid var(--border-color);
      padding-top: 20px;
    }

    .results-container.active {
      display: block;
    }

    .results-title {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .results-list {
      list-style: none;
      padding: 0;
    }

    .result-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      margin-bottom: 6px;
      background-color: var(--item-bg);
      border-radius: 4px;
      border-right: 4px solid var(--default-border);
    }

    .download-button {
      background-color: #2ecc71;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 3px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .download-button:hover {
      background-color: #27ae60;
    }

    /* Add these styles */
    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .delete-all-button {
      background-color: #e74c3c;
      color: var(--button-text);
      border: none;
      padding: 5px 15px;
      border-radius: 3px;
      cursor: pointer;
    }

    .delete-all-button:hover {
      background-color: #c0392b;
    }

    /* Add these styles for the loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-left: 8px;
      border: 3px solid var(--border-color);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .process-button.processing {
      background-color: #7f8c8d;
      cursor: not-allowed;
    }

    /* Add this CSS for the folder upload button */
    .uploading {
      background-color: #f0f0f0;
      cursor: not-allowed;
    }

    .custom-file-input label.uploading {
      background-color: #7f8c8d;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="loginOverlay" class="login-overlay">
    <div class="login-modal">
      <div class="login-header">
        <h2 id="modalTitle">×”×ª×—×‘×¨×•×ª</h2>
        <button class="close-button">ï¿½ï¿½ï¿½ï¿½</button>
      </div>
      <div class="login-options">
        <!-- Add mode toggle buttons -->
        <div class="mode-toggle">
          <button class="toggle-button active" data-mode="signin">×”×ª×—×‘×¨×•×ª</button>
          <button class="toggle-button" data-mode="signup">×”×¨×©××”</button>
        </div>

        <form class="login-form">
          <input type="email" placeholder="××™××™×™×œ" required>
          <input type="password" placeholder="×¡×™×¡××”" required>
          <!-- Add confirm password field (hidden by default) -->
          <input type="password" id="confirmPassword" placeholder="××™××•×ª ×¡×™×¡××”" required class="signup-field" style="display: none;">
          <button type="submit" class="login-submit" id="submitButton">×”×ª×—×‘×¨</button>
        </form>

        <div class="login-divider">
          <span>××•</span>
        </div>

        <div class="social-login">
          <button class="google-login">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google">
            <span id="googleButtonText">×”×ª×—×‘×¨ ×¢× Google</span>
          </button>
          <button class="github-login">
            <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub">
            <span id="githubButtonText">×”×ª×—×‘×¨ ×¢× GitHub</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="header-container">
    <h1>×”×¢×œ××ª ×§×‘×¦×™×</h1>
    <button class="login-button">×”×ª×—×‘×¨×•×ª</button>
  </div>
  <!-- Container for the list of uploaded files -->
  <ul class="file-list" id="fileList"></ul>

  <!-- File input and process button container -->
  <div class="button-container">
    <div class="custom-file-input">
      <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg" multiple>
      <label for="fileInput">×”×¢×œ××ª ××¡××›×™×...</label>
      <input type="file" id="folderInput" accept=".pdf,.jpg,.jpeg" webkitdirectory directory multiple>
      <label for="folderInput">×”×¢×œ××ª ×ª×™×§×™×™×”...</label>
    </div>
    <div class="action-buttons">
      <button id="processButton" class="process-button">×¢×™×‘×•×“</button>
      <button id="deleteAllButton" class="delete-all-button">××—×§ ×”×›×œ</button>
    </div>
  </div>

  <!-- Add new message container -->
  <div id="messageContainer" class="message-container"></div>

  <!-- Add this HTML right after the message container div -->
  <div id="resultsContainer" class="results-container">
    <div class="results-title">×ª×•×¦××•×ª</div>
    <ul id="resultsList" class="results-list"></ul>
  </div>

  <script>
    // Add these constants at the start of your script section, after DEBUG
    const API_BASE_URL = 'https://localhost:443/api/v1';
    const AUTH_BASE_URL = 'https://localhost:443/auth';
    const fetchConfig = {
      credentials: 'include',
      mode: 'cors'
    };

    // Add this near the top of your script
    const DEBUG = true;

    function debug(...args) {
      if (DEBUG) {
        console.log(...args);
      }
    }

    // Get references to DOM elements
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const processButton = document.getElementById('processButton');
    const messageContainer = document.getElementById('messageContainer');
    const messages = [
      "××ª×—×™×œ ×‘×¢×™×‘×•×“ ×”××¡××›×™×...",
      "×‘×•××§ ××ª ×¤×•×¨××˜ ×”×§×‘×¦×™×...",
      "×××ª × ×”×•×›×Ÿ...",
      "×”×¢×™×‘×•×“ ×”×•×©×œ×!"
    ];

    // Add this after all the existing variable declarations
    const exampleFile = {
      name: 'large_document.pdf',
      size: 6291456  // 6MB in bytes
    };

    // Add these cookie utility functions at the start of your script section
    const cookieUtils = {
      set: function(name, value, days = 7) {
        const d = new Date();
        d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "expires=" + d.toUTCString();
        document.cookie = name + "=" + value + ";" + expires + ";path=/;Secure;SameSite=Strict";
      },
      
      get: function(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) === ' ') c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
      },
      
      delete: function(name) {
        document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/;Secure;SameSite=Strict';
      }
    };

    // Update the auth token handling
    let authToken = cookieUtils.get('authToken');

    // Update signInAnonymous function
    async function signInAnonymous() {
      try {
        debug('Attempting anonymous sign in...');
        const response = await fetch(`${AUTH_BASE_URL}/signInAnonymous`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'include',
          mode: 'cors'
        });
        
        debug('Sign in response:', response.status);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        if (!result.token) {
          throw new Error('No token received');
        }
        authToken = result.token;
        cookieUtils.set('authToken', authToken); // Save token to cookie
        debug('Token received and saved:', authToken);
        return authToken;
      } catch (error) {
        debug('Sign in error:', error);
        throw error;
      }
    }

    // Update signIn function
    async function signIn(email, password) {
      try {
        const response = await fetch(`${AUTH_BASE_URL}/signIn`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: email,
            password: password
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        authToken = result.token;
        cookieUtils.set('authToken', authToken); // Save token to cookie
        console.log('Sign in successful');
        return authToken;
      } catch (error) {
        console.error('Sign in failed:', error);
        throw error;
      }
    }

    // Add a sign out function
    function signOut() {
      authToken = null;
      cookieUtils.delete('authToken');
      // Clear the file list
      fileList.innerHTML = '';
      // Clear results
      const resultsContainer = document.getElementById('resultsContainer');
      resultsContainer.classList.remove('active');
      document.getElementById('resultsList').innerHTML = '';
      // Add back the example file
      addFileToList(
        exampleFile,
        'warning',
        '×§×•×‘×¥ ×’×“×•×œ ××“×™ - ×”×§×•×‘×¥ ×—×•×¨×’ ×××’×‘×œ×ª 5MB ×”××•××œ×¦×ª. ×”×¢×œ××” ×¢×©×•×™×” ×œ×”×™×•×ª ××™×˜×™×ª.'
      );
      addMessage('×”×ª× ×ª×§×ª ×‘×”×¦×œ×—×”');
    }

    // Add a function to check token validity
    async function checkToken() {
      if (!authToken) return false;
      
      try {
        const response = await fetch(`${API_BASE_URL}/getFilesInfo?customerDataEntryName=Default`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Accept': 'application/json'
          },
          ...fetchConfig
        });

        if (!response.ok) {
          if (response.status === 401) {
            authToken = null;
            cookieUtils.delete('authToken');
            return false;
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return true;
      } catch (error) {
        console.error('Token check failed:', error);
        return false;
      }
    }

    // Add this function to load files with existing token
    async function loadExistingFiles() {
      try {
        const response = await fetch(`${API_BASE_URL}/getFilesInfo?customerDataEntryName=Default`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Accept': 'application/json'
          },
          ...fetchConfig
        });

        if (!response.ok) {
          if (response.status === 401) {
            // Token is invalid, remove it
            authToken = null;
            cookieUtils.delete('authToken');
            throw new Error('Invalid token');
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        debug('Files info:', result);

        // Clear existing files (except example file)
        const files = Array.from(fileList.children);
        files.forEach(file => {
          if (!file.querySelector('.file-header span').textContent.includes('large_document.pdf')) {
            fileList.removeChild(file);
          }
        });

        // Add files from server
        if (Array.isArray(result)) {
          result.forEach(fileInfo => {
            if (fileInfo.type === 'FormError') {
              addFileToList(
                { name: fileInfo.fileName || 'Unknown file', size: 0 },
                'error',
                fileInfo.reason,
                fileInfo.fileId
              );
            } else {
              addFileToList(
                { name: fileInfo.fileName, size: 0 },
                null,
                `×–×•×”×” ×›-${fileInfo.type} ×œ×©× ×ª ${fileInfo.taxYear}`,
                fileInfo.fileId
              );
            }
          });
        }
      } catch (error) {
        debug('Failed to load files:', error);
        // Only show message if it's not an auth error
        if (!error.message.includes('Invalid token')) {
          addMessage('×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×”×§×‘×¦×™×: ' + error.message);
        }
        throw error;
      }
    }

    // Update window load event to try existing token first and load any existing results
    window.addEventListener('load', async () => {
      // Add example file
      addFileToList(
        exampleFile,
        'warning',
        '×§×•×‘×¥ ×’×“×•×œ ××“×™ - ×”×§×•×‘×¥ ×—×•×¨×’ ×××’×‘×œ×ª 5MB ×”××•××œ×¦×ª. ×”×¢×œ××” ×¢×©×•×™×” ×œ×”×™×•×ª ××™×˜×™×ª.'
      );

      try {
        // If we have a token, try to use it
        if (authToken) {
          await loadExistingFiles();
          await loadResults();
          debug('Successfully loaded files and results with existing token');
        } else {
          // No token, sign in anonymously
          debug('No token found, signing in anonymously');
          await signInAnonymous();
          await loadExistingFiles();
          await loadResults();
        }
      } catch (error) {
        debug('Error during initialization:', error);
        // If loading files failed, try anonymous sign in
        if (error.message.includes('Invalid token')) {
          debug('Token invalid, signing in anonymously');
          await signInAnonymous();
          await loadExistingFiles();
          await loadResults();
        }
      }
    });

    // Add this at the start of your script
    const fileIdMap = new Map(); // Store file IDs for deletion

    // Update the addFileToList function to store fileId
    function addFileToList(file, status = null, statusMessage = '', fileId = null) {
      const li = document.createElement('li');
      li.className = 'file-item';
      if (status) {
        li.classList.add(status);
      }

      // Store the fileId in our map
      if (fileId) {
        fileIdMap.set(file.name, fileId);
      }

      const fileInfo = document.createElement('div');
      fileInfo.className = 'file-info';

      const fileHeader = document.createElement('div');
      fileHeader.className = 'file-header';

      // Create status icon
      const statusIcon = document.createElement('span');
      statusIcon.className = 'status-icon';
      switch(status) {
        case 'warning':
          statusIcon.textContent = 'âš ï¸';
          break;
        case 'error':
          statusIcon.textContent = 'âŒ';
          break;
        default:
          statusIcon.textContent = 'âœ“';
      }

      const fileName = document.createElement('span');
      // Show path if available
      if (file.path) {
        fileName.textContent = `${file.path}`;
      } else {
        fileName.textContent = file.name;
      }

      fileHeader.appendChild(statusIcon);
      fileHeader.appendChild(fileName);
      fileInfo.appendChild(fileHeader);

      if (statusMessage) {
        const statusMessageSpan = document.createElement('span');
        statusMessageSpan.className = 'status-message';
        statusMessageSpan.textContent = statusMessage;
        fileInfo.appendChild(statusMessageSpan);
      }

      const deleteButton = document.createElement('button');
      deleteButton.textContent = 'ğŸ—‘ï¸';  // Change from '××—×§' to trash can icon
      deleteButton.className = 'delete-button';
      deleteButton.title = '××—×§';  // Add tooltip with the word "Delete" in Hebrew
      deleteButton.addEventListener('click', async () => {
        try {
          const fileId = fileIdMap.get(file.name);
          if (fileId) {
            const response = await fetch(`${API_BASE_URL}/deleteFile?fileId=${fileId}&customerDataEntryName=Default`, {
              method: 'DELETE',
              headers: {
                'Authorization': `Bearer ${authToken}`
              },
              ...fetchConfig
            });

            if (!response.ok) {
              throw new Error(`Delete failed: ${response.status}`);
            }

            // Remove from UI only after successful deletion
            fileList.removeChild(li);
            fileIdMap.delete(file.name);
          }
        } catch (error) {
          console.error('Delete failed:', error);
          addMessage('×©×’×™××” ×‘××—×™×§×ª ×”×§×•×‘×¥: ' + error.message, 'error');
        }
      });

      li.appendChild(fileInfo);
      li.appendChild(deleteButton);
      fileList.appendChild(li);
    }

    // Add this helper function at the start of your script
    function isValidFileType(file) {
      const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg'];
      if (!validTypes.includes(file.type)) {
        return {
          valid: false,
          message: '×¡×•×’ ×§×•×‘×¥ ×œ× × ×ª××š - ×¨×§ ×§×‘×¦×™ PDF ××• JPG ××•×ª×¨×™×'
        };
      }
      return { valid: true };
    }

    // Add this helper function to check if file is in GeneratedTaxForms folder
    function isInGeneratedTaxFormsFolder(filePath) {
      return filePath.includes('GeneratedTaxForms');
    }

    // Add this function to update the file list from server response
    function updateFileList(result) {
      // Clear existing files (except example file)
      const files = Array.from(fileList.children);
      files.forEach(file => {
        if (!file.querySelector('.file-header span').textContent.includes('large_document.pdf')) {
          fileList.removeChild(file);
        }
      });

      // Clear the file ID map (except example file)
      for (const [name, id] of fileIdMap) {
        if (!name.includes('large_document.pdf')) {
          fileIdMap.delete(name);
        }
      }

      // Add all files from the response
      if (Array.isArray(result)) {
        result.forEach(fileInfo => {
          if (fileInfo.type === 'FormError') {
            addFileToList(
              { name: fileInfo.fileName || 'Unknown file', size: 0 },
              'error',
              fileInfo.reason,
              fileInfo.fileId
            );
          } else {
            addFileToList(
              { name: fileInfo.fileName, size: 0 },
              null,
              `×–×•×”×” ×›-${fileInfo.type} ×œ×©× ×ª ${fileInfo.taxYear}`,
              fileInfo.fileId
            );
          }
        });
      }
    }

    // Update file input handler to always use individual uploads
    fileInput.addEventListener('change', async () => {
      const files = Array.from(fileInput.files);
      
      try {
        if (!authToken) {
          await signInAnonymous();
        }

        // Filter out invalid files first
        const validFiles = files.filter(file => {
          if (isInGeneratedTaxFormsFolder(file.webkitRelativePath || file.name)) {
            return false;
          }

          const validation = isValidFileType(file);
          if (!validation.valid) {
            addMessage(validation.message, 'error');
            return false;
          }

          return true;
        });

        if (validFiles.length === 0) {
          return;
        }

        // Upload files one by one
        for (const file of validFiles) {
          try {
            const formData = new FormData();
            formData.append('file', file);
            
            const metadata = {
              customerDataEntryName: 'Default'
            };
            formData.append('metadata', new Blob([JSON.stringify(metadata)], {
              type: 'application/json'
            }));

            const response = await fetch(`${API_BASE_URL}/uploadFile`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${authToken}`
              },
              body: formData,
              ...fetchConfig
            });

            const result = await response.json();
            console.log('Upload response:', result);
            updateFileList(result);

          } catch (error) {
            console.error('Upload failed:', error);
            addMessage('×©×’×™××” ×‘×”×¢×œ××ª ×”×§×•×‘×¥: ' + error.message, 'error');
          }
        }

      } catch (error) {
        console.error('Authentication failed:', error);
        addMessage('×©×’×™××” ×‘××™××•×ª: ' + error.message, 'error');
      }
      
      fileInput.value = '';
    });

    // Update folder upload handler to always use individual uploads
    folderInput.addEventListener('change', async () => {
      const files = Array.from(folderInput.files);
      const folderLabel = folderInput.nextElementSibling;
      const originalText = folderLabel.textContent;
      
      try {
        if (!authToken) {
          await signInAnonymous();
        }

        // Sort and filter files
        const validFiles = files
          .sort((a, b) => {
            const pathA = a.webkitRelativePath || a.name;
            const pathB = b.webkitRelativePath || b.name;
            return pathA.localeCompare(pathB);
          })
          .filter(file => {
            if (isInGeneratedTaxFormsFolder(file.webkitRelativePath || file.name)) {
              return false;
            }

            const validation = isValidFileType(file);
            if (!validation.valid) {
              addMessage(validation.message, 'error');
              return false;
            }

            return true;
          });

        if (validFiles.length === 0) {
          return;
        }

        // Show uploading status in button
        folderLabel.innerHTML = 'â³ ××¢×œ×”...';
        folderLabel.classList.add('uploading');

        // Upload files one by one
        for (const file of validFiles) {
          try {
            const formData = new FormData();
            formData.append('file', file);
            
            const metadata = {
              customerDataEntryName: 'Default'
            };
            formData.append('metadata', new Blob([JSON.stringify(metadata)], {
              type: 'application/json'
            }));

            const response = await fetch(`${API_BASE_URL}/uploadFile`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${authToken}`
              },
              body: formData,
              ...fetchConfig
            });

            const result = await response.json();
            console.log('Upload response:', result);
            updateFileList(result);

          } catch (error) {
            console.error('Upload failed:', error);
            addMessage('×©×’×™××” ×‘×”×¢×œ××ª ×”×§×•×‘×¥: ' + error.message, 'error');
          }
        }

      } catch (error) {
        console.error('Authentication failed:', error);
        addMessage('×©×’×™××” ×‘××™××•×ª: ' + error.message, 'error');
      } finally {
        // Restore button text
        folderLabel.innerHTML = originalText;
        folderLabel.classList.remove('uploading');
        folderInput.value = '';
      }
    });

    // Update the process button handler
    processButton.addEventListener('click', async () => {
      try {
        if (!authToken) {
          await signInAnonymous();
        }

        // Disable button and show spinner
        processButton.disabled = true;
        processButton.classList.add('processing');
        const spinner = document.createElement('span');
        spinner.className = 'spinner';
        processButton.appendChild(spinner);

        // Clear previous messages
        messageContainer.innerHTML = '';
        
        // Show initial processing message
        addMessage("××ª×—×™×œ ×‘×¢×™×‘×•×“ ×”××¡××›×™×...", 'info');

        const response = await fetch(`${API_BASE_URL}/processFiles`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            customerDataEntryName: 'Default'
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Processing response:', result);

        // Handle fatal error if present
        if (result.fatalProcessingError) {
          addMessage('×©×’×™××” ×§×¨×™×˜×™×ª: ' + result.fatalProcessingError, 'error');
        }

        // Handle warnings if present
        if (result.processingWarnings && result.processingWarnings.length > 0) {
          result.processingWarnings.forEach(warning => {
            addMessage('××–×”×¨×”: ' + warning, 'warning');
          });
        }

        // If no fatal errors, load results
        if (!result.fatalProcessingError) {
          addMessage("×˜×•×¢×Ÿ ×ª×•×¦××•×ª...", 'info');
          // Wait a moment for processing to complete on server
          await new Promise(resolve => setTimeout(resolve, 1000));
          await loadResults();
          addMessage("×”×¢×™×‘×•×“ ×”×•×©×œ×", 'info');
        }

      } catch (error) {
        console.error('Processing failed:', error);
        addMessage('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×‘×¦×™×: ' + error.message, 'error');
      } finally {
        // Re-enable button and remove spinner
        processButton.disabled = false;
        processButton.classList.remove('processing');
        const spinner = processButton.querySelector('.spinner');
        if (spinner) {
          processButton.removeChild(spinner);
        }
      }
    });

    // Update addMessage function to handle message types
    function addMessage(text, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message-item';
      if (type) {
        messageDiv.classList.add(type);
      }

      const messageText = document.createElement('span');
      messageText.className = 'message-text';
      messageText.textContent = text;

      const dismissButton = document.createElement('button');
      dismissButton.className = 'dismiss-button';
      dismissButton.textContent = 'âœ•';
      dismissButton.addEventListener('click', () => {
        messageContainer.removeChild(messageDiv);
      });

      messageDiv.appendChild(messageText);
      messageDiv.appendChild(dismissButton);
      messageContainer.appendChild(messageDiv);
    }

    // Add this to your existing script
    const loginButton = document.querySelector('.login-button');
    const loginOverlay = document.getElementById('loginOverlay');
    const closeButton = document.querySelector('.close-button');
    const loginForm = document.querySelector('.login-form');
    const toggleButtons = document.querySelectorAll('.toggle-button');
    const modalTitle = document.getElementById('modalTitle');
    const submitButton = document.getElementById('submitButton');
    const confirmPassword = document.getElementById('confirmPassword');
    const googleButtonText = document.getElementById('googleButtonText');
    const githubButtonText = document.getElementById('githubButtonText');

    loginButton.addEventListener('click', () => {
      loginOverlay.classList.add('active');
    });

    closeButton.addEventListener('click', () => {
      loginOverlay.classList.remove('active');
    });

    loginOverlay.addEventListener('click', (e) => {
      if (e.target === loginOverlay) {
        loginOverlay.classList.remove('active');
      }
    });

    // Function to switch between signin and signup modes
    function switchMode(mode) {
      const isSignup = mode === 'signup';
      
      // Update UI elements
      modalTitle.textContent = isSignup ? '×”×¨×©××”' : '×”×ª×—×‘×¨×•×ª';
      submitButton.textContent = isSignup ? '×”×™×¨×©×' : '×”×ª×—×‘×¨';
      confirmPassword.style.display = isSignup ? 'block' : 'none';
      googleButtonText.textContent = isSignup ? '×”×¨×©××” ×¢× Google' : '×”×ª×—×‘×¨ ×¢× Google';
      githubButtonText.textContent = isSignup ? '×”×¨×©××” ×¢× GitHub' : '×”×ª×—×‘×¨ ×¢× GitHub';

      // Update active toggle button
      toggleButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
    }

    // Add click handlers for mode toggle buttons
    toggleButtons.forEach(button => {
      button.addEventListener('click', () => {
        switchMode(button.dataset.mode);
      });
    });

    // Update the login form submit handler
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const isSignup = document.querySelector('.toggle-button.active').dataset.mode === 'signup';
      const email = loginForm.querySelector('input[type="email"]').value;
      const password = loginForm.querySelector('input[type="password"]').value;
      
      try {
        if (isSignup) {
          // Handle signup
          const response = await fetch(`${AUTH_BASE_URL}/register`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email: email,
              password: password
            })
          });
          if (!response.ok) throw new Error('Registration failed');
          addMessage('× ×¨×©××ª ×‘×”×¦×œ×—×”! ×× × ×”×ª×—×‘×¨/×™');
        } else {
          // Handle signin
          await signIn(email, password);
          addMessage('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”!');
        }
        loginOverlay.classList.remove('active');
      } catch (error) {
        console.error('Auth failed:', error);
        addMessage('×©×’×™××” ×‘××™××•×ª: ' + error.message);
      }
    });

    document.querySelector('.google-login').addEventListener('click', () => {
      console.log('Google login clicked');
    });

    document.querySelector('.github-login').addEventListener('click', () => {
      console.log('GitHub login clicked');
    });

    // Add these functions before the window load event listener
    async function loadResults() {
      try {
        const response = await fetch(`${API_BASE_URL}/getResultsInfo?customerDataEntryName=Default`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Accept': 'application/json'
          },
          ...fetchConfig
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const results = await response.json();
        
        // Clear previous messages
        messageContainer.innerHTML = '';

        // Handle messages if present
        results.forEach(result => {
          if (result.messages) {
            // Handle fatal error if present
            if (result.messages.fatalProcessingError) {
              addMessage('×©×’×™××” ×§×¨×™×˜×™×ª: ' + result.messages.fatalProcessingError, 'error');
            }

            // Handle warnings if present
            if (result.messages.processingWarnings && result.messages.processingWarnings.length > 0) {
              result.messages.processingWarnings.forEach(warning => {
                addMessage('××–×”×¨×”: ' + warning, 'warning');
              });
            }
          }
        });

        // Display result files
        displayResults(results);
      } catch (error) {
        console.error('Failed to load results:', error);
        // Only show error if it's not an auth error
        if (!error.message.includes('Invalid token')) {
          addMessage('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×ª×•×¦××•×ª: ' + error.message, 'error');
        }
      }
    }

    function displayResults(results) {
      const resultsContainer = document.getElementById('resultsContainer');
      const resultsList = document.getElementById('resultsList');
      resultsList.innerHTML = ''; // Clear existing results

      if (!Array.isArray(results) || results.length === 0) {
        resultsContainer.classList.remove('active');
        return;
      }

      let hasFiles = false;

      results.forEach(result => {
        if (result.file) {
          hasFiles = true;
          const li = document.createElement('li');
          li.className = 'result-item';

          const fileName = document.createElement('span');
          fileName.textContent = result.file.fileName;

          const downloadButton = document.createElement('button');
          downloadButton.className = 'download-button';
          downloadButton.innerHTML = 'â¬‡ï¸ ×”×•×¨×“×”';
          downloadButton.addEventListener('click', () => downloadResult(result.file.fileName));

          li.appendChild(fileName);
          li.appendChild(downloadButton);
          resultsList.appendChild(li);
        }
      });

      if (hasFiles) {
        resultsContainer.classList.add('active');
      } else {
        resultsContainer.classList.remove('active');
      }
    }

    async function downloadResult(fileName) {
      try {
        const response = await fetch(
          `${API_BASE_URL}/downloadResultsFile?fileName=${encodeURIComponent(fileName)}&customerDataEntryName=Default`,
          {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${authToken}`
            },
            ...fetchConfig
          }
        );

        if (!response.ok) {
          throw new Error(`Download failed: ${response.status}`);
        }

        // Create blob from response
        const blob = await response.blob();
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        addMessage(`×”×§×•×‘×¥ ${fileName} ×”×•×¨×“ ×‘×”×¦×œ×—×”`);
      } catch (error) {
        console.error('Download failed:', error);
        addMessage('×©×’×™××” ×‘×”×•×¨×“×ª ×”×§×•×‘×¥: ' + error.message, 'error');
      }
    }

    // Add this after the other button references
    const deleteAllButton = document.getElementById('deleteAllButton');

    // Update delete all handler - remove confirmation dialog
    deleteAllButton.addEventListener('click', async () => {
      try {
        if (!authToken) {
          await signInAnonymous();
        }

        const response = await fetch(`${API_BASE_URL}/deleteAllFiles?customerDataEntryName=Default`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${authToken}`
          },
          ...fetchConfig
        });

        if (!response.ok) {
          throw new Error(`Delete failed: ${response.status}`);
        }

        const result = await response.json();
        console.log('Delete all response:', result);

        // Clear the file list except for the example file
        const files = Array.from(fileList.children);
        files.forEach(file => {
          if (!file.querySelector('.file-header span').textContent.includes('large_document.pdf')) {
            fileList.removeChild(file);
          }
        });

        // Clear the file ID map
        fileIdMap.clear();

        // Refresh the file list
        await loadExistingFiles();

      } catch (error) {
        console.error('Delete all failed:', error);
        addMessage('×©×’×™××” ×‘××—×™×§×ª ×›×œ ×”×§×‘×¦×™×: ' + error.message, 'error');
      }
    });
  </script>
</body>
</html>
